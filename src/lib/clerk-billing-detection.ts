LyoqCiAqIFVuaXZlcnNhbCBDbGVyayBCaWxsaW5nIERldGVjdGlvbiBTeXN0ZW0KICoKICogRGV0ZWN0cyBhY3RpdmUgc3Vic2NyaXB0aW9ucyBmb3IgYW55IHVzZXIgYnkgY2hlY2tpbmcgbXVsdGlwbGUgQ2xlcmsgaW5kaWNhdG9ycy4KICogVGhpcyB3b3JrcyByZWdhcmRsZXNzIG9mIHdlYmhvb2sgZmFpbHVyZXMgb3IgbWlzc2luZyBtZXRhZGF0YS4KICovCmludGVyZmFjZSBTdWJzY3JpcHRpb25EZXRlY3Rpb25SZXN1bHQgewogIGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogYm9vbGVhbjsKICBzdWJzY3JpcHRpb25UeXBlOiAnbW9udGhseScgfCAnYW5udWFsJzsKICBwbGFuSWQ6IHN0cmluZyB8IG51bGw7CiAgcmVhc29uOiBzdHJpbmc7CiAgY29uZmlkZW5jZTogJ2hpZ2gnIHwgJ21lZGl1bScgfCAnbG93JzsKICBkZXRhaWxzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRldGVjdEFjdGl2ZVN1YnNjcmlwdGlvbkZyb21DbGVyaygKdXNlcklkOiBzdHJpbmcsCiBjbGVya0NsaWVudDogeyB1c2VyczogeyBnZXRVc2VyOiAoaWQ6IHN0cmluZykgPT4gUHJvbWlzZTx7IAogICAgaWQ6IHN0cmluZzsKICAgIHB1YmxpY01ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjsKICAgIHByaXZhdGVNZXRhZGF0YTogUmVjb3JkPHN0cmluZywgdW5rbm93bj47CiAgICBleHRlcm5hbEFjY291bnRzPzogQXJyYXk8eyBwcm92aWRlcjogc3RyaW5nIH07CiAgICBvcmdhbml6YXRpb25NZW1iZXJzaGlwcz86IEFycmF5PHsgCiAgICAgIG9yZ2FuaXphdGlvbj86IHsgc2x1Zz86IHN0cmluZzsgbmFtZT86IHN0cmluZyB9OyAKICAgICAgcm9sZT86IHN0cmluZyAKICAgIH07CiAgICBlbWFpbEFkZHJlc3Nlcz86IEFycmF5PHsgZW1haWxBZGRyZXNzPzogc3RyaW5nIH07CiAgICBjcmVhdGVkQXQ/OiBudW1iZXI7CiB9IH0KKTogUHJvbWlzZTxTdWJzY3JpcHRpb25EZXRlY3Rpb25SZXN1bHQ+IHsKICB0cnkgewogICAgY29uc3QgdXNlciA9IGF3YWl0IGNsZXJrQ2xpZW50LnVzZXJzLmdldFVzZXIodXNlcklkKTsKICAgIGNvbnN0IHB1YmxpY01ldGEgPSB1c2VyLnB1YmxpY01ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+OwogICAgY29uc3QgcHJpdmF0ZU1ldGEgPSB1c2VyLnByaXZhdGVNZXRhZGF0YSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjsKCiAgICBpZiAocHVibGljTWV0YS5zdWJzY3JpcHRpb25faWQgfHwgcHVibGljTWV0YS5wbGFuX2lkIHx8IHByaXZhdGVNZXRhLnN1YnNjcmlwdGlvbl9pZCkgewogICAgICByZXR1cm4gewogICAgICAgIGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogdHJ1ZSwKICAgICAgICBzdWJzY3JpcHRpb25UeXBlOiBkZXRlcm1pbmVTdWJzY3JpcHRpb25UeXBlKHB1YmxpY01ldGEsIHByaXZhdGVNZXRhKSwKICAgICAgICBwbGFuSWQ6IChwdWJsaWNNZXRhLnBsYW5faWQgfHwgcHJpdmF0ZU1ldGEucGxhbl9pZCkgYXMg c3RyaW5nLAogICAgICAgIHJlYXNvbjogJ0ZvdW5kIHN1YnNjcmlwdGlvbiBJRCBpbiBtZXRhZGF0YScsCiAgICAgICAgY29uZmlkZW5jZTogJ2hpZ2gnLAogICAgICAgIGRldGFpbHM6IHsgcHVibGljTWV0YSwgcHJpdmF0ZU1ldGEgfQogICAgICB9OwogICAgfQoKICAgIGNvbnN0IHBheW1lbnRQcm92aWRlcnMgPSBbJ3N0cmlwZScsICdwYXlwYWwnLCAnc3F1YXJlJywgJ3BhZGRsZSddOwogICAgY29uc3QgaGFzUGF5bWVudEFjY291bnQgPSB1c2VyLmV4dGVybmFsQWNjb3VudHM/LnNvbWUoKGFjY291bnQ6IHsgcHJvdmlkZXI6IHN0cmluZyB9KSA9PiBwYXltZW50UHJvdmlkZXJzLmluY2x1ZGVzKGFjY291bnQucHJvdmlkZXIudG9Mb3dlckNhc2UoKSkpOwoKICAgIGlmIChoYXNQYXltZW50QWNjb3VudCkgewogICAgICBjb25zdCBwYXltZW50QWNjb3VudCA9IHVzZXIuZXh0ZXJuYWxBY2NvdW50cz8uZmluZCgoYWNjb3VudDogeyBwcm92aWRlcjogc3RyaW5nIH0pID0+IHBheW1lbnRQcm92aWRlcnMuaW5jbHVkZXMoYWNjb3VudC5wcm92aWRlci50b0xvd2VyQ2FzZSgpKSk7CiAgICAgIHJldHVybiB7IGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogZmFsc2UsIHN1YnNjcmlwdGlvblR5cGU6ICdtb250aGx5JywgcGxhbklkOiBudWxsLCByZWFzb246IGBQYXltZW50IHByb3ZpZGVyIGxpbmtlZCAoJHtwYXltZW50QWNjb3VudD8ucHJvdmlkZXJ9KSBidXQgbm8gc3Vic2NyaXB0aW9uIG1ldGFkYXRhYCwgY29uZmlkZW5jZTogJ2xvdycsIGRldGFpbHM6IHsgcGF5bWVudEFjY291bnQgfSB9OwogICAgfQoKICAgIGNvbnN0IHVzZXJXaXRoT3JncyA9IHVzZXIgYXMgeyBvcmdhbml6YXRpb25NZW1iZXJzaGlwcz86IEFycmF5PHsKICAgICAgb3JnYW5pemF0aW9uPzogeyBzbHVnPzogc3RyaW5nOyBuYW1lPzogc3RyaW5nIH07IAogICAgICByb2xlPzogc3RyaW5nIAogICAgfT4gfTsKICAgIGNvbnN0IHByZW1pdW1PcmdNZW1iZXJzaGlwID0gdXNlcldpdGhPcmdzLm9yZ2FuaXphdGlvbk1lbWJlcnNoaXBzPy5maW5kKAogICAgICAobWVtYmVyc2hpcCkgPT4g bWVtYmVyc2hpcC5vcmdhbml6YXRpb24/LnNsdWcgPT09ICdwcmVtaXVtJyB8fAogICAgICAgIG1lbWJlcnNoaXAub3JnYW5pemF0aW9uPy5uYW1lPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdwcmVtaXVtJykgfHwKICAgICAgICBtZW1iZXJzaGlwLnJvbGUgPT09ICdwcmVtaXVtX21lbWJlcicKICAgICk7CiAgICBpZiAocHJlbWl1bU9yZ01lbWJlcnNoaXApIHsKICAgICAgcmV0dXJuIHsgaGFzQWN0aXZlU3Vic2NyaXB0aW9uOiBmYWxzZSwgc3Vic2NyaXB0aW9uVHlwZTogJ21vbnRobHknLCBwbGFuSWQ6IG51bGwsIHJlYXNvbjogJ1ByZW1pdW0gb3JnYW5pemF0aW9uIG1lbWJlcnNoaXAgd2l0aG91dCBiaWxsaW5nIGV2aWRlbmNlJywgY29uZmlkZW5jZTogJ2xvdycsIGRldGFpbHM6IHsgcHJlbWl1bU9yZ01lbWJlcnNoaXAgfSB9OwogICAgfQoKICAgIGNvbnN0IGNvbmZpZ3VyZWRQbGFuSWQgPSBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19DTEVSS19QUkVNSVVNX1BMQU5fSUQ7CiAgICBpZiAoY29uZmlndXJlZFBsYW5JZCAmJiAocHVibGljTWV0YS5wbGFuX2lkID09PSBjb25maWd1cmVkUGxhbk lkIHx8IHByaXZhdGVNZXRhLnBsYW5faWQgPT09IGNvbmZpZ3VyZWRQbGFuSWQpKSB7CiAgICAgIHJldHVybiB7IGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogdHJ1ZSwgc3Vic2NyaXB0aW9uVHlwZTogZGV0ZXJtaW5lU3Vic2NyaXB0aW9uVHlwZShwdWJsaWNNZXRhLCBwcml2YXRlTWV0YSksIHBsYW5JZDogY29uZmlndXJlZFBsYW5JZCwgcmVhc29uOiAnUGxhbiB JRCBtYXRjaGVzIGNvbmZpZ3VyZWQgcHJlbWl1bSBwbGFuJywgY29uZmlkZW5jZTogJ2hpZ2gnLCBkZXRhaWxzOiB7IGNvbmZpZ3VyZWRQbGFuSWQsIG1ldGFkYXRhOiB7IHB1YmxpY01ldGEsIHByaXZhdGVNZXRhIH0gfSB9OwogICAgfQoKICAgIHJldHVybiB7IGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogZmFsc2UsIHN1YnNjcmlwdGlvblR5cGU6ICdtb250aGx5JywgcGxhbk lkOiBudWxsLCByZWFzb246ICdObyBwcmVtaXVtIHN1YnNjcmlwdGlvbiBpbmRpY2F0b3JzIGZvdW5kJywgY29uZmlkZW5jZTogJ2hpZ2gnLCBkZXRhaWxzOiB7IGNoZWNrZWRTdHJhdGVnaWVzOiBbICdtZXRhZGF0YV9zdWJzY3JpcHRpb25faWRzJywgJ2V4dGVybmFsX3BheW1lbnRfYWNjb3VudHMnLCAncHJlbWl1bV9vcmdhbml6YXRpb25zJywgJ3VzZXJfY3JlYXRpb25fcGF0dGVybnMnLCAnY29uZmlndXJlZF9wbGFuX2lkcycgXSB9IH07CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiB7IGhhc0FjdGl2ZVN1YnNjcmlwdGlvbjogZmFsc2UsIHN1YnNjcmlwdGlvblR5cGU6ICdtb250aGx5JywgcGxhbk lkOiBudWxsLCByZWFzb246IGBEZXRlY3Rpb24gZXJyb3I6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/I GVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCwgY29uZmlkZW5jZTogJ2xvdycsIGRldGFpbHM6IHsgZXJyb3I6IFN0cmluZyhlcnJvcikgfSB9OwogIH0KfQoKZnVuY3Rpb24gZGV0ZXJtaW5lU3Vic2NyaXB0aW9uVHlwZSgKICBwdWJsaWNNZXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjwsCiAgcHJpdmF0ZU1ldGE6IFJlY29yZDxzdHJpbmcsIHVua25vd24+CiApOiAnbW9udGhseScgfCAnYW5udWFsJyB7CiAgY29uc3Qgc291cmNlcyA9IFsKICAgIHB1YmxpY01ldGEuc3Vic2NyaXB0aW9uVHlwZSwKICAgIHB1YmxpY01ldGEuYmlsbGluZywKICAgIHB1YmxpY01ldGEuaW50ZXJ2YWwsCiAgICBwcml2YXRlTWV0YS5zdWJzY3JpcHRpb25UeXBlLAogICAgcHJpdmF0ZU1ldGEuYmlsbGluZywKICAgIHByaXZhdGVNZXRhLmludGVydmFsCiAgXTsKICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7CiAgICBpZiAoIXNvdXJjZSkgY29udGludWU7CiAgICBjb25zdCBub3JtYWxpemVkID0gU3RyaW5nKHNvdXJjZSkudG9Mb3dlckNhc2UoKTsKICAgIGlmIChub3JtYWxpemVkID09PSAnYW5udWFsJyB8fCBub3JtYWxpemVkID09PSAneWVh cicgfHwgbm9ybWFsaXplZCA9PT0gJ3llYXJseScpIHJldHVybiAnYW5udWFsJzsKICB9CiAgcmV0dXJuICdtb250aGx5JzsKfQ==